@using TechNova.Models.Core
@model TechNova.Models.ViewModels.ProductDetailsViewModel

@{
    ViewData["Title"] = "Chi tiết sản phẩm";

    var colorList = (Model.Product.Color ?? "")
        .Split(',', StringSplitOptions.RemoveEmptyEntries)
        .Select(c => c.Trim())
        .ToArray();

    var storageList = Model.Product.Storage?.Split(',') ?? new string[] { };
    bool requireColor = colorList.Any();
    bool requireStorage = storageList.Any();
}

<link rel="stylesheet" href="~/css/product-detail.css" />

<div class="product-detail-container">
    <!-- Left: Images -->
    <div class="product-images">
        <img src="@Model.Product.MainImageUrl" class="main-image" alt="Main Product Image" />

        <div class="thumbnail-images">
            @if (!string.IsNullOrWhiteSpace(Model.Product.SubImage1Url))
            {
                <img src="@Model.Product.SubImage1Url" class="thumbnail-img" />
            }
            @if (!string.IsNullOrWhiteSpace(Model.Product.SubImage2Url))
            {
                <img src="@Model.Product.SubImage2Url" class="thumbnail-img" />
            }
            @if (!string.IsNullOrWhiteSpace(Model.Product.SubImage3Url))
            {
                <img src="@Model.Product.SubImage3Url" class="thumbnail-img" />
            }
        </div>
    </div>


    <!-- Right: Product Info -->
    <div class="product-info">
        <!-- Thương hiệu và tồn kho -->
        @if (Model.Product.Brand != null)
        {
            <div class="product-meta">
                <span class="brand-name"><strong>@Model.Product.Brand.Name</strong></span>
            </div>
        }
        <h2 class="product-name">@Model.Product.Name</h2>


        <div class="product-price">
            @if (Model.Product.DiscountPercent > 0)
            {
                <span class="price-discounted">@Model.Product.DiscountedPrice.ToString("N0")₫</span>
                <span class="price-original">@Model.Product.Price.ToString("N0")₫</span>
                <span class="price-save">Tiết kiệm @((Model.Product.Price - Model.Product.DiscountedPrice).ToString("N0"))₫</span>
            }
            else
            {
                <span class="price-discounted">@Model.Product.Price.ToString("N0")₫</span>
            }
        </div>

        <!-- Storage Options -->
        @if (storageList.Any())
        {
            <div class="option-section">
                <h5>Dung lượng</h5>
                <div class="option-boxes" id="StorageOptions">
                    @foreach (var s in storageList)
                    {
                        <div class="option-box storage-box" data-storage="@s">@s</div>
                    }
                </div>
            </div>
        }

        <!-- Color Options -->
        @if (colorList.Any())
        {
            <div class="option-section">
                <h5>Màu sắc</h5>
                <div class="option-boxes" id="ColorOptions">
                    @foreach (var c in colorList)
                    {
                        <div class="option-box color-circle" data-color="@c" style="background-color:@c;" title="@c"></div>
                    }
                </div>
            </div>
        }

        <!-- Quantity -->
        <div class="quantity-section">
            <label>Số lượng</label>
            <div class="quantity-control">
                <button type="button" onclick="changeQty(-1)">−</button>
                <input type="number" name="quantity" id="quantity" value="1" min="1" />
                <button type="button" onclick="changeQty(1)">+</button>
            </div>
        </div>
        <div class="product-meta">
            <span class="stock-qty">Kho còn: <strong>@Model.Product.StockQuantity</strong> sản phẩm</span>
        </div>
        <!-- Action Buttons -->
        <form method="post" asp-controller="Cart" asp-action="AddToCart" onsubmit="return validateSelection();">
            <input type="hidden" name="productId" value="@Model.Product.ProductId" />
            <input type="hidden" name="color" id="SelectedColor" />
            <input type="hidden" name="storage" id="SelectedStorage" />
            <input type="hidden" name="quantity" id="FormQuantity" value="1" />

            <div class="button-group">
                <button type="submit" class="btn-add-to-cart">
                    🛒 Thêm vào giỏ - @Model.Product.DiscountedPrice.ToString("N0")₫
                </button>
                <button type="button" class="btn-buy-now">Mua ngay</button>
            </div>
        </form>
    </div>

    <!-- Tabs Section: full width -->
    <div class="product-tabs">
        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="description">Mô tả</button>
            <button class="tab-btn" data-tab="specs">Thông số kỹ thuật</button>
            <button class="tab-btn" data-tab="reviews">Đánh giá (@Model.Reviews.Count)</button>
            <button class="tab-btn" data-tab="shipping">Giao hàng & Đổi trả</button>
        </div>

        <div class="tab-content">
            <div class="tab-panel active" id="description">
                @Html.Raw(Model.Product.Description)
            </div>


            <div class="tab-panel" id="specs">
                @if (Model.Product.ProductSpecifications?.Any() == true)
                {
                    var groupedSpecs = Model.Product.ProductSpecifications
                    .GroupBy(ps => ps.SpecificationItem.Group)
                    .OrderBy(g => g.Key.DisplayOrder);

                    foreach (var group in groupedSpecs)
                    {
                        <h5 class="spec-group-title mt-3">@group.Key.GroupName</h5>
                        <table class="table table-sm table-bordered">
                            <tbody>
                                @foreach (var item in group.OrderBy(ps => ps.SpecificationItem.DisplayOrder))
                                {
                                    <tr>
                                        <th style="width: 40%;">@item.SpecificationItem.ItemName</th>
                                        <td>@item.Value</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                }
                else
                {
                    <p class="text-muted">Chưa có thông số kỹ thuật cho sản phẩm này.</p>
                }
            </div>


            <div class="tab-panel" id="reviews">
                @if (Model.Reviews?.Any() == true)
                {
                    @foreach (var review in Model.Reviews)
                    {
                        <div class="review-item">
                            <strong>@review.Rating★</strong> bởi <strong>@review.User.Username</strong>
                            <p>@review.Comment</p>
                            <div class="text-muted">@review.CreatedAt.ToString("dd/MM/yyyy")</div>
                        </div>
                    }

                }
                else
                {
                    <p class="text-muted">Chưa có đánh giá nào.</p>
                }

                @if (Model.CanReview)
                {
                    <form method="post" asp-action="SubmitReview">
                        <input type="hidden" name="ProductId" value="@Model.Product.ProductId" />
                        <div class="form-group mt-3">
                            <label>Đánh giá (1-5 sao)</label>
                            <input type="number" name="Rating" class="form-control" min="1" max="5" required />
                        </div>
                        <div class="form-group">
                            <label>Bình luận</label>
                            <textarea name="Comment" class="form-control" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary mt-2">Gửi đánh giá</button>
                    </form>
                }
                else
                {
                    <div class="alert alert-info mt-3">Chỉ người đã mua sản phẩm này mới được đánh giá.</div>
                }
            </div>


            <div class="tab-panel policy-tab" id="shipping">
                <h4><i class="bi bi-truck"></i> Giao hàng</h4>
                <ul>
                    <li>🚚 Miễn phí giao hàng toàn quốc với đơn từ <strong>500.000₫</strong></li>
                    <li>⏱ Thời gian giao hàng: từ <strong>1–3 ngày làm việc</strong></li>
                    <li>🔎 Có thể kiểm tra tình trạng đơn hàng qua trang “Đơn hàng của tôi”</li>
                </ul>

                <h4><i class="bi bi-arrow-repeat"></i> Đổi/trả hàng</h4>
                <ul>
                    <li>📦 Đổi hàng trong vòng <strong>7 ngày</strong> kể từ ngày nhận hàng</li>
                    <li>🛠 Sản phẩm lỗi kỹ thuật được đổi/trả miễn phí</li>
                    <li>❗ Không áp dụng đổi/trả với sản phẩm đã qua sử dụng</li>
                </ul>

                <p>👉 Mọi thắc mắc, xin liên hệ <strong>hotline</strong>: <a href="tel:19001234">1900 1234</a> hoặc <a href="@Url.Action("Contact", "Home")">Liên hệ chúng tôi</a>

            </div>

        </div>
    </div>

</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const mainImage = document.querySelector('.main-image');
            const thumbnails = document.querySelectorAll('.thumbnail-img');

            thumbnails.forEach(thumb => {
                thumb.addEventListener('click', function () {
                    if (mainImage) {
                        mainImage.src = this.src;
                    }
                });
            });
        });
    </script>

    <script>
        // Validate khi submit form
                function validateSelection() {
            const requireColor = @requireColor.ToString().ToLower();   // true/false
            const requireStorage = @requireStorage.ToString().ToLower();

            const color = document.getElementById("SelectedColor").value;
            const storage = document.getElementById("SelectedStorage").value;

            if (requireColor && !color) {
                alert("Vui lòng chọn màu sắc.");
                return false;
            }

            if (requireStorage && !storage) {
                alert("Vui lòng chọn dung lượng.");
                return false;
            }

            return true;
        }


        // Xử lý chọn màu
        document.querySelectorAll('.color-circle').forEach(el => {
            el.addEventListener('click', () => {
                document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('selected'));
                el.classList.add('selected');
                document.getElementById("SelectedColor").value = el.dataset.color;
            });
        });

        // Xử lý chọn dung lượng
        document.querySelectorAll('.storage-box').forEach(el => {
            el.addEventListener('click', () => {
                document.querySelectorAll('.storage-box').forEach(s => s.classList.remove('selected'));
                el.classList.add('selected');
                document.getElementById("SelectedStorage").value = el.dataset.storage;
            });
        });

        // Thay đổi số lượng
        function changeQty(change) {
            const qtyInput = document.getElementById("quantity");
            let qty = parseInt(qtyInput.value) || 1;
            qty = Math.max(1, qty + change);
            qtyInput.value = qty;
            document.getElementById("FormQuantity").value = qty;
        }
        // Đổi ảnh chính khi bấm ảnh phụ
        document.querySelectorAll('.sub-images img').forEach(img => {
            img.addEventListener('click', () => {
                const mainImg = document.querySelector('.main-img');
                if (mainImg) {
                    mainImg.src = img.src;
                }
            });
        });
        // Tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const tabId = btn.dataset.tab;
                document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
            });
        });
    </script>
}
